<div class="min-h-screen w-full bg-[#dbd6d3]">
  <div class="mx-auto max-w-[1200px] p-4">
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_420px] gap-4">
      <div class="rounded-2xl bg-[#f2f1ed] border border-black/10 shadow-[0_20px_50px_rgba(0,0,0,.10)] overflow-hidden">
        <div class="px-5 py-4 border-b border-black/10 bg-[var(--action)]">
          <h2 class="text-[15px] font-semibold text-white tracking-wide">
            Resumen de la Venta
          </h2>
        </div>

        <div class="p-5 space-y-4">
          <div class="rounded-xl bg-white border border-black/10 p-4">
            <h3 class="text-[12px] font-semibold text-[#354044] mb-3">Cliente</h3>

            @if (cart().customer) {
              <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-full flex items-center justify-center
                            bg-[#87b26d] text-white font-bold text-[12px]">
                  {{ cart().customer!.name.charAt(0).toUpperCase() }}
                </div>

                <div class="min-w-0">
                  <div class="text-[13px] font-semibold text-[#354044] truncate">
                    {{ cart().customer!.name }}
                  </div>

                  <div class="mt-0.5 text-[11px] text-[#354044]/65 flex items-center gap-2">
                    <span>{{ cart().customer!.purchasesCount }} compras</span>

                    @if (cart().discountPercent > 0) {
                      <span class="px-2 py-0.5 rounded-full text-[10px] font-bold
                                   bg-[var(--cat-active)] text-white border border-black/10">
                        -{{ cart().discountPercent }}%
                      </span>
                    }
                  </div>
                </div>
              </div>
            } @else {
              <div class="flex items-center justify-between gap-2">
                <span class="text-[12px] font-semibold text-[#354044]">
                  Cliente general
                </span>
                <span class="text-[11px] text-[#354044]/60">
                  (Sin cliente asignado)
                </span>
              </div>
            }
          </div>

          <div class="rounded-xl bg-white border border-black/10 overflow-hidden">
            <div class="px-4 py-3 border-b border-black/10">
              <h3 class="text-[12px] font-semibold text-[#354044]">Productos</h3>
            </div>

            <div class="max-h-[360px] overflow-y-auto">
              @for (item of cart().items; track item.productId) {
                <div class="px-4 py-3 flex items-center gap-3 border-b border-black/5">
                  <div class="h-10 w-10 rounded-md overflow-hidden border border-black/10 bg-[#f2f1ed] flex-shrink-0">
                    @if (item.product.image) {
                      <img [src]="item.product.image" [alt]="item.product.name" class="h-full w-full object-cover" />
                    } @else {
                      <div class="h-full w-full flex items-center justify-center text-[11px] font-bold text-[#354044]">
                        {{ item.product.name.charAt(0).toUpperCase() }}
                      </div>
                    }
                  </div>

                  <div class="min-w-0 flex-1">
                    <div class="text-[12px] font-semibold text-[#354044] truncate">
                      {{ item.product.name }}
                    </div>
                    <div class="text-[11px] text-[#354044]/60">
                      {{ formatCurrency(item.unitPrice) }} × {{ item.quantity }}
                    </div>
                  </div>

                  <div class="text-[12px] font-bold text-[#354044]">
                    {{ formatCurrency(item.lineTotal) }}
                  </div>
                </div>
              }
            </div>
          </div>

          <div class="rounded-xl bg-white border border-black/10 p-4">
            <h3 class="text-[12px] font-semibold text-[#354044] mb-3">Totales</h3>

            <div class="space-y-2 text-[12px] text-[#354044]">
              <div class="flex justify-between">
                <span class="text-[#354044]/75">Subtotal</span>
                <span class="font-semibold">{{ formatCurrency(cart().subtotal) }}</span>
              </div>

              @if (cart().discountPercent > 0) {
                <div class="flex justify-between">
                  <span class="text-[#354044]/75">
                    Descuento ({{ cart().discountPercent }}%)
                  </span>
                  <span class="font-semibold text-[#87b26d]">
                    -{{ formatCurrency(cart().discountAmount) }}
                  </span>
                </div>
              }

              <div class="pt-2 mt-2 border-t border-black/10 flex justify-between items-center">
                <span class="font-semibold">Total</span>
                <span class="text-[14px] font-bold text-[#354044]">
                  {{ formatCurrency(cart().total) }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PAGO -->
      <div class="rounded-2xl bg-[#f2f1ed] border border-black/10 shadow-[0_20px_50px_rgba(0,0,0,.10)] overflow-hidden">
        <div class="px-5 py-4 border-b border-black/10 bg-[var(--action)]">
          <h2 class="text-[15px] font-semibold text-white tracking-wide">
            Método de Pago
          </h2>
        </div>

        <div class="p-5 space-y-4">
          <div class="rounded-xl bg-white border border-black/10 p-4">
            <h3 class="text-[12px] font-semibold text-[#354044] mb-3">
              Selecciona el método:
            </h3>

            <div class="grid grid-cols-2 gap-2">
              @for (method of paymentMethods; track method.id) {
                <label class="cursor-pointer">
                  <input
                    type="radio"
                    name="paymentMethod"
                    [value]="method.id"
                    [checked]="paymentMethod() === method.id"
                    (change)="updatePaymentMethod(method.id)"
                    class="sr-only"
                  />

                  <div
                    class="rounded-xl border border-black/10 px-3 py-2.5
                           flex items-center gap-2
                           bg-[#f2f1ed]
                           transition
                           hover:bg-black/5"
                    [class]="paymentMethod() === method.id
                      ? 'ring-2 ring-[#87b26d]/40 border-[#87b26d] bg-white'
                      : ''"
                  >
                    <span class="text-[12px] font-semibold text-[#354044]">
                      {{ method.name }}
                    </span>
                  </div>
                </label>
              }
            </div>
          </div>

          @if (showCashInput()) {
            <div class="rounded-xl bg-white border border-black/10 p-4">
              <h3 class="text-[12px] font-semibold text-[#354044] mb-3">Efectivo</h3>

              <div class="flex items-center justify-between gap-3">
                <label for="cashAmount" class="text-[12px] text-[#354044]/75">
                  Recibido:
                </label>

                <div class="flex items-center gap-2 rounded-lg border border-black/10 bg-[#f2f1ed] px-3 py-2 w-[180px]">
                  <span class="text-[12px] text-[#354044]/60">$</span>
                  <input
                    type="number"
                    id="cashAmount"
                    min="0"
                    step="0.01"
                    [value]="cashAmount()"
                    (input)="updateCashAmount($event)"
                    placeholder="0.00"
                    class="w-full bg-transparent outline-none text-[12px] text-[#354044]
                           placeholder:text-[#354044]/40"
                  />
                </div>
              </div>

              @if (changeAmount() > 0) {
                <div class="mt-3 rounded-lg border border-black/10 bg-[#87b26d]/15 px-3 py-2 flex justify-between text-[12px]">
                  <span class="text-[#354044]/75">Cambio a entregar</span>
                  <span class="font-semibold text-[#354044]">
                    {{ formatCurrency(changeAmount()) }}
                  </span>
                </div>
              } @else if (cashAmount() > 0 && cashAmount() < cart().total) {
                <div class="mt-3 rounded-lg border border-black/10 bg-[#e52b08]/10 px-3 py-2 flex justify-between text-[12px]">
                    <span class="text-[#354044]">Faltan</span>
                    <span>
                      {{ formatCurrency(cart().total - cashAmount()) }}
                    </span>
                </div>
              }
            </div>
          }

          <div class="rounded-xl bg-white border border-black/10 p-4">
            <button
              [disabled]="isProcessing() || cart().isEmpty"
              (click)="processSale()"
              class="w-full rounded-xl px-4 py-3
                     bg-[var(--cat-active)] text-white
                     text-[13px] font-semibold
                     border border-black/10
                     shadow-[0_12px_26px_rgba(0,0,0,.12)]
                     transition
                     hover:opacity-95
                     disabled:opacity-50 disabled:cursor-not-allowed"
            >
              @if (isProcessing()) {
                <span class="inline-flex items-center gap-2">
                  <span class="h-4 w-4 rounded-full border-2 border-white/40 border-t-white animate-spin"></span>
                  <span>Procesando venta...</span>
                </span>
              } @else {
                <span class="inline-flex items-center justify-between w-full">
                  <span class="inline-flex items-center gap-2">
                    <span>✅</span>
                    <span>Confirmar Venta</span>
                  </span>
                  <span class="text-white/90 text-[12px] font-bold">
                    {{ formatCurrency(cart().total) }}
                  </span>
                </span>
              }
            </button>

            <p class="mt-3 text-[11px] text-[#354044]/65 leading-snug">
              Al confirmar, se registrará la venta, actualizará el inventario y se incrementará el contador de compras del cliente.
            </p>
          </div>
        </div>
      </div>
    </div>

    <app-success
      [isVisible]="showSuccessModal()"
      [title]="successTitle()"
      [message]="successMessage()"
      [details]="saleDetails()"
    ></app-success>
  </div>
</div>
