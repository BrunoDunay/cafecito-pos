<div
  class="fixed inset-0 z-[100] flex items-center justify-center p-4
         bg-black/40 backdrop-blur-[2px]"
  (click)="onClose()"
>
  <div
    class="w-full max-w-md max-h-[90vh] overflow-y-auto
           rounded-2xl bg-[#f2f1ed]
           shadow-[0_25px_60px_rgba(0,0,0,.18)]"
    (click)="$event.stopPropagation()"
  >
    <div class="px-6 py-4 bg-[var(--edit)] border-b border-black/10 rounded-t-2xl flex justify-between items-center">
      <h2 class="text-[15px] font-semibold text-white">Nuevo Usuario</h2>

      <button
        (click)="onClose()"
        class="h-8 w-8 rounded-lg border border-white/40
               flex items-center justify-center
               text-white hover:bg-white hover:text-[var(--action)] transition"
        type="button"
      >
        ✕
      </button>
    </div>

    <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="p-6 space-y-4">
      @if (errorMessage) {
        <div class="bg-white border border-black/10 text-[#e52b08] px-4 py-3 rounded-xl text-sm">
          {{ errorMessage }}
        </div>
      }

      <div>
        <label class="block text-xs font-semibold text-[#354044] mb-1">
          Nombre <span class="text-[#e52b08]">*</span>
        </label>
        <input
          type="text"
          formControlName="name"
          class="w-full px-3 py-2 rounded-xl bg-white border border-black/10
                 text-sm text-[#354044]
                 placeholder:text-[#354044]/45
                 focus:outline-none focus:border-[#87b26d] focus:ring-2 focus:ring-[#87b26d]/25"
          [class.border-[#e52b08]]="hasError('name', 'required') || hasError('name', 'minlength')"
          placeholder="Ej: Juan Pérez"
        />
        @if (hasError('name', 'required')) { <p class="mt-1 text-xs text-[#e52b08]">El nombre es obligatorio</p> }
        @if (hasError('name', 'minlength')) { <p class="mt-1 text-xs text-[#e52b08]">Mínimo 2 caracteres</p> }
      </div>

      <div>
        <label class="block text-xs font-semibold text-[#354044] mb-1">
          Email <span class="text-[#e52b08]">*</span>
        </label>
        <input
          type="email"
          formControlName="email"
          class="w-full px-3 py-2 rounded-xl bg-white border border-black/10
                 text-sm text-[#354044]
                 placeholder:text-[#354044]/45
                 focus:outline-none focus:border-[#87b26d] focus:ring-2 focus:ring-[#87b26d]/25"
          [class.border-[#e52b08]]="hasError('email', 'required') || hasError('email', 'email')"
          placeholder="ejemplo@correo.com"
        />
        @if (hasError('email', 'required')) { <p class="mt-1 text-xs text-[#e52b08]">El email es obligatorio</p> }
        @if (hasError('email', 'email')) { <p class="mt-1 text-xs text-[#e52b08]">Ingresa un email válido</p> }
      </div>

      <div>
        <label class="block text-xs font-semibold text-[#354044] mb-1">
          Contraseña <span class="text-[#e52b08]">*</span>
        </label>
        <input
          type="password"
          formControlName="password"
          class="w-full px-3 py-2 rounded-xl bg-white border border-black/10
                 text-sm text-[#354044]
                 placeholder:text-[#354044]/45
                 focus:outline-none focus:border-[#87b26d] focus:ring-2 focus:ring-[#87b26d]/25"
          [class.border-[#e52b08]]="hasError('password', 'required') || hasError('password', 'minlength')"
          placeholder="••••••••"
        />
        @if (hasError('password', 'required')) { <p class="mt-1 text-xs text-[#e52b08]">La contraseña es obligatoria</p> }
        @if (hasError('password', 'minlength')) { <p class="mt-1 text-xs text-[#e52b08]">Mínimo 6 caracteres</p> }
      </div>

      <div>
        <label class="block text-xs font-semibold text-[#354044] mb-1">
          Rol <span class="text-[#e52b08]">*</span>
        </label>
        <select
          formControlName="role"
          class="w-full px-3 py-2 rounded-xl bg-white border border-black/10
                 text-sm text-[#354044]
                 focus:outline-none focus:border-[#87b26d] focus:ring-2 focus:ring-[#87b26d]/25"
        >
          <option value="seller">Vendedor</option>
          <option value="admin">Administrador</option>
        </select>
      </div>

      <div class="flex gap-3 pt-2">
        <button
          type="button"
          (click)="onClose()"
          class="flex-1 px-4 py-2 rounded-xl text-sm font-semibold
                 bg-white border border-black/10
                 text-[#354044] hover:bg-black/5 transition"
        >
          Cancelar
        </button>

        <button
          type="submit"
          [disabled]="userForm.invalid || isLoading"
          class="flex-1 px-4 py-2 rounded-xl text-sm font-semibold
                 bg-[#354044] text-white
                 hover:opacity-95 transition
                 disabled:opacity-50 disabled:cursor-not-allowed
                 flex items-center justify-center gap-2"
        >
          @if (isLoading) {
            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Creando...</span>
          } @else {
            Crear Usuario
          }
        </button>
      </div>
    </form>
  </div>
</div>
